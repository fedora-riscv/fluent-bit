C99 compatibility fixes for build-time feature probing.

Include <unistd.h> for the close function.  Do not call the
undeclared __tls_get_addr function; rely on __thread support
for feature probing.  Define _GNU_SOURCE to obtain prototypes
of fallocate and memmem.

Submitted upstream: <https://github.com/fluent/fluent-bit/pull/6704>

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 1820d9b84f552168..60f4bc933c7ed39e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -658,6 +658,7 @@ endif()
 check_c_source_compiles("
   #include <sys/types.h>
   #include <sys/socket.h>
+  #include <unistd.h>
   int main() {
       int sock;
       sock = socket(AF_UNIX, SOCK_STREAM, 0);
@@ -896,8 +897,7 @@ if(NOT FLB_POSIX_TLS)
   check_c_source_compiles("
    __thread int a;
    int main() {
-       __tls_get_addr(0);
-       return 0;
+       return a;
    }" FLB_HAVE_C_TLS)
   if(FLB_HAVE_C_TLS)
     FLB_DEFINITION(FLB_HAVE_C_TLS)
diff --git a/lib/chunkio/CMakeLists.txt b/lib/chunkio/CMakeLists.txt
index e71c224bc92cef8e..bc1d3fe3e5e81485 100644
--- a/lib/chunkio/CMakeLists.txt
+++ b/lib/chunkio/CMakeLists.txt
@@ -81,6 +81,7 @@ endif()
 
 # fallocate(2) support
 check_c_source_compiles("
+  #define _GNU_SOURCE
   #include <fcntl.h>
   int main() {
      fallocate(0,0,0);
diff --git a/lib/monkey/CMakeLists.txt b/lib/monkey/CMakeLists.txt
index 15e62e81da923f13..97c52d9d9d291ab2 100644
--- a/lib/monkey/CMakeLists.txt
+++ b/lib/monkey/CMakeLists.txt
@@ -180,8 +180,7 @@ if(NOT MK_PTHREAD_TLS)
   check_c_source_compiles("
      __thread int a;
      int main() {
-         __tls_get_addr(0);
-         return 0;
+          return a;
      }" HAVE_C_TLS)
 
   if(HAVE_C_TLS)
diff --git a/lib/monkey/mk_core/CMakeLists.txt b/lib/monkey/mk_core/CMakeLists.txt
index 0e74f8d4587504b8..739fff3d8514f736 100644
--- a/lib/monkey/mk_core/CMakeLists.txt
+++ b/lib/monkey/mk_core/CMakeLists.txt
@@ -62,6 +62,7 @@ set(src "${src}"
   )
 
 check_c_source_compiles("
+  #define _GNU_SOURCE
   #include <string.h>
   int main() {
      char  haystack[] = \"1234\";
